<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Manage Books (Live API)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --custom-orange: #FF7B54;
            --custom-orange-dark: #F7653B;
            --custom-blue: #0d6efd;
            --custom-light-blue: #e7f0ff;
            --custom-text: #343a40;
            --custom-background: #f9fafb;
            --custom-border: #dee2e6;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--custom-background);
            color: var(--custom-text);
        }

        .main-content {
            padding: 2rem;
        }

        .card {
            border: 1px solid var(--custom-border);
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö CSS ‡∏Ç‡∏≠‡∏á nav-tabs ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
        .nav-tabs {
            border-bottom: none;
        }



        /* Admin Nav Styles */
        .admin-nav .nav-link {
            color: var(--custom-blue);
            font-weight: 500;
            border-bottom: 3px solid transparent;
            padding-bottom: 0.75rem;
            margin-right: 1.5rem;
        }

        .admin-nav .nav-link.active {
            color: var(--custom-text);
            font-weight: 700;
            border-bottom-color: var(--custom-blue);
        }

        .admin-nav .nav-link:hover {
            color: #0056b3;
        }

        .btn-primary {
            background-color: var(--custom-orange);
            border-color: var(--custom-orange);
            font-weight: 500;
        }

        .btn-primary:hover,
        .btn-primary:focus {
            background-color: var(--custom-orange-dark);
            border-color: var(--custom-orange-dark);
        }

        .table-hover tbody tr:hover {
            background-color: var(--custom-light-blue);
        }

        .table th {
            font-weight: 600;
            color: #495057;
        }

        .status-active {
            color: #198754;
            background-color: #d1e7dd;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-Inactive {
            color: #ff4b04;
            background-color: #f5b2ab;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .action-icons i {
            cursor: pointer;
            margin: 0 6px;
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .action-icons i:hover {
            transform: scale(1.2);
        }

        .book-image-sm {
            width: 40px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="main-content">
            <header class="mb-3">
                <h2>Admin Dashboard</h2>
                <p class="text-muted mb-0">Manage your bookstore operations</p>
            </header>

            <nav class="d-flex align-items-center border-bottom mb-4">
                <ul class="nav admin-nav">
                    <li class="nav-item"><a class="nav-link" href="overview.html">üìà Overview</a></li>
                    <li class="nav-item"><a class="nav-link active" href="admin.html">üìñ Manage Books</a></li>
                    <li class="nav-item"><a class="nav-link" href="manage_order.html">üì¶ Manage Orders</a></li>
                </ul>
                <div class="ms-auto">
                    <a href="index.html" class="btn btn-outline-primary">
                        <i class="bi bi-shop me-2"></i>Go to Storefront
                    </a>
                </div>
            </nav>

            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h4>Book Management</h4>
                        <p class="text-muted mb-0">Add, edit, and manage your book inventory</p>
                    </div>
                    <div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bookModal"
                            onclick="prepareAddBook()">
                            <i class="bi bi-plus-circle-fill me-2"></i>Add Book
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Book</th>
                                <th>Author</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="book-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookModalLabel">Add New Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bookForm" novalidate>
                        <input type="hidden" id="bookId">
                        <div class="row">
                            <div class="col-md-8 mb-3"><label for="bookName" class="form-label">Book Name</label><input
                                    type="text" class="form-control" id="bookName" required></div>
                            <div class="col-md-4 mb-3"><label for="bookAuthor" class="form-label">Author</label><input
                                    type="text" class="form-control" id="bookAuthor" required></div>
                        </div>
                        <div class="mb-3"><label for="bookDescription" class="form-label">Description</label><textarea
                                class="form-control" id="bookDescription" rows="4" required></textarea></div>
                        <div class="row">
                            <div class="col-md-4 mb-3"><label for="bookCategory"
                                    class="form-label">Category</label><input type="text" class="form-control"
                                    id="bookCategory" required></div>
                            <div class="col-md-4 mb-3"><label for="bookPrice" class="form-label">Price</label><input
                                    type="number" class="form-control" id="bookPrice" step="0.01" required></div>
                            <div class="col-md-4 mb-3"><label for="bookStock" class="form-label">Stock</label><input
                                    type="number" class="form-control" id="bookStock" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="imageUrl" class="form-label">Image URL</label><input
                                    type="text" class="form-control" id="imageUrl" required></div>
                            <div class="col-md-6 mb-3"><label for="oldPrice" class="form-label">Old Price
                                    (Optional)</label><input type="number" class="form-control" id="oldPrice"
                                    step="0.01"></div>
                        </div>
                        <div class="mb-3">
                        <label for="bookStatus" class="form-label">Status</label>
                        <select class="form-select" id="bookStatus" required>
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveBook()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 12px;">
                <div class="modal-body text-center p-4"><i class="bi bi-check-circle-fill text-success"
                        style="font-size: 3rem;"></i>
                    <h5 class="modal-title mt-3">Success!</h5>
                    <p id="successMessage"></p><button type="button" class="btn btn-primary"
                        data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 12px;">
                <div class="modal-body text-center p-4"><i class="bi bi-x-circle-fill text-danger"
                        style="font-size: 3rem;"></i>
                    <h5 class="modal-title mt-3">Error!</h5>
                    <p id="errorMessage"></p><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Axios Interceptor (‡∏ï‡∏±‡∏ß‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö Response)
    axios.interceptors.response.use(
        (response) => {
            return response;  // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (status 2xx)
        },
        async (error) => {
            const originalRequest = error.config;
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 401 (Unauthorized) ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏≠‡∏á retry
            if (error.response && error.response.status === 401 && !originalRequest._retry) {
                originalRequest._retry = true;
                try {
                    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ç‡∏≠ Token ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å /api/refresh
                    await axios.post("/api/refresh", {}, { withCredentials: true });
                    // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏¢‡∏¥‡∏á Request ‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥
                    console.log("Token refreshed, retrying original request...");
                    return axios(originalRequest);
                } catch (refreshError) {
                    console.error("Refresh token failed, logging out:", refreshError);
                    alert("‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà");
                    window.location.href = '/login.html'; // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
                    return Promise.reject(refreshError);
                }
            }
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô error ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 401 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ error.response
            return Promise.reject(error);
        }
    );
        const ADMIN_API_URL = '/api/admin/products';
        let localBooks = [];
        let editingBookId = null;
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            successModal.show();
        }
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            errorModal.show();
        }

        document.addEventListener('DOMContentLoaded', () => { fetchBooks(); });

        async function fetchBooks() {
            try {
                const response = await axios.get(ADMIN_API_URL, { withCredentials: true });
                localBooks = response.data.products;
                renderBooks(localBooks);
            } catch (error) {
                console.error('Error fetching books:', error);
                showError('Failed to fetch books. Please check console.');
                renderBooks([]);
            }
        }

        function renderBooks(books) {
            const tableBody = document.getElementById('book-table-body');
            tableBody.innerHTML = '';
            if (!books || !books.length) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No books found.</td></tr>';
                return;
            }
            books.forEach(book => {
                const statusClass = book.is_active ? 'status-active': 'status-Inactive'
                const statusText = book.is_active ? 'Active' : 'Inactive';
                tableBody.innerHTML += `
                <tr id="book-${book.book_id}">
                    <td><div class="d-flex align-items-center"><img src="${book.image_url}" class="book-image-sm me-3" alt="${book.book_name}"><div><h6 class="mb-0">${book.book_name}</h6><small class="text-muted">ID: ${book.book_id}</small></div></div></td>
                    <td>${book.author}</td><td>${book.book_type}</td><td>‡∏ø${parseFloat(book.book_price).toFixed(2)}</td>
                    <td>${book.stock}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td class="action-icons"><i class="bi bi-eye text-info" title="View"></i><i class="bi bi-pencil-square text-warning" title="Edit" data-bs-toggle="modal" data-bs-target="#bookModal" onclick="prepareEditBook(${book.book_id})"></i><i class="bi bi-trash-fill text-danger" title="Delete" onclick="deleteBook(${book.book_id})"></i></td>
                </tr>`;
            });
        }

        function prepareAddBook() {
            const form = document.getElementById('bookForm');
            form.reset();
            form.classList.remove('was-validated');
            document.getElementById('bookModalLabel').innerText = 'Add New Book';
            editingBookId = null;
        }

        function prepareEditBook(id) {
            const form = document.getElementById('bookForm');
            form.classList.remove('was-validated');
            const book = localBooks.find(b => Number(b.book_id) === Number(id));
            if (!book) return showError('Book not found');
            document.getElementById('bookModalLabel').innerText = 'Edit Book';
            editingBookId = id;
            document.getElementById('bookId').value = book.book_id;
            document.getElementById('bookName').value = book.book_name;
            document.getElementById('bookDescription').value = book.description;
            document.getElementById('bookAuthor').value = book.author;
            document.getElementById('bookCategory').value = book.book_type;
            document.getElementById('bookPrice').value = book.book_price;
            document.getElementById('bookStock').value = book.stock;
            document.getElementById('oldPrice').value = book.old_price || '';
            document.getElementById('imageUrl').value = book.image_url;
            document.getElementById('bookStatus').value = book.is_active ? 'true' : 'false';
        }

        async function saveBook() {
            const form = document.getElementById('bookForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            const bookData = {
                book_name: document.getElementById('bookName').value,
                author: document.getElementById('bookAuthor').value,
                description: document.getElementById('bookDescription').value,
                book_type: document.getElementById('bookCategory').value,
                book_price: parseFloat(document.getElementById('bookPrice').value),
                stock: parseInt(document.getElementById('bookStock').value),
                image_url: document.getElementById('imageUrl').value,
                old_price: parseFloat(document.getElementById('oldPrice').value) || null,
                is_active: document.getElementById('bookStatus').value === 'true'
            };
            try {
                if (editingBookId) {
                    await axios.put(`${ADMIN_API_URL}/${editingBookId}`, bookData, { withCredentials: true });
                } else {
                    await axios.post(ADMIN_API_URL, bookData, { withCredentials: true });
                }
                await fetchBooks();
                bootstrap.Modal.getInstance(document.getElementById('bookModal')).hide();
                showSuccess('Book saved successfully!');
            } catch (error) {
                console.error('Error saving book:', error);
                showError(`Error saving book: ${error.message}`);
            }
        }

        async function deleteBook(id) {
            if (!confirm('Are you sure you want to delete this book?')) return;
            try {
                await axios.delete(`${ADMIN_API_URL}/${id}`, { withCredentials: true });
                await fetchBooks();
            } catch (error) {
                console.error('Error deleting book:', error);
                showError(`Error deleting book: ${error.message}`);
            }
        }
    </script>
</body>

</html>
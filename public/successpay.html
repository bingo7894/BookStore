<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful | BookStore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #007BFF;
            --primary-orange: #FF7A00;
            --light-bg: #f8f9fa;
            --success-green: #28a745;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--light-bg);
        }

        .success-container {
            max-width: 600px;
        }

        .success-icon {
            font-size: 6rem;
            color: var(--success-green);
        }

        .summary-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .btn-orange {
            background-color: var(--primary-orange);
            border-color: var(--primary-orange);
            color: #fff;
        }

        .btn-orange:hover {
            background-color: #e66a00;
            border-color: #e66a00;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="container vh-100 d-flex flex-column justify-content-center align-items-center">
        <div class="success-container text-center bg-white p-5 rounded-4 shadow-sm">
            <i class="bi bi-check-circle-fill success-icon mb-3"></i>
            <h1 class="display-5 fw-bold">ชำระเงินสำเร็จ!</h1>
            <p class="lead text-muted">ขอบคุณสำหรับการสั่งซื้อ ระบบได้ส่งอีเมลยืนยันไปให้คุณแล้ว</p>

            <div class="summary-card text-start p-3 my-4">
                <h6 class="mb-3">สรุปรายการ:</h6>
                <div class="d-flex justify-content-between">
                    <span>หมายเลขคำสั่งซื้อ:</span>
                    <strong id="order-id"></strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>วันที่:</span>
                    <strong id="order-date"></strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>ยอดชำระ:</span>
                    <strong id="order-total"></strong>
                </div>
            </div>
            <div id="status" class="text-center mt-5"></div>
            <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                <a href="index.html" class="btn btn-primary btn-lg px-4 gap-3">
                    <i class="bi bi-arrow-left"></i> กลับไปหน้าแรก
                </a>
                <a href="order.html" class="btn btn-orange btn-lg px-4">
                    <i class="bi bi-receipt"></i> ดูรายละเอียดคำสั่งซื้อ
                </a>
            </div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
        // Axios Interceptor (ตัวดักจับ Response)
    axios.interceptors.response.use(
        (response) => {
            return response;  // ถ้าสำเร็จ (status 2xx)
        },
        async (error) => {
            const originalRequest = error.config;
            // ตรวจสอบว่าเป็น 401 (Unauthorized) และยังไม่ได้ลอง retry
            if (error.response && error.response.status === 401 && !originalRequest._retry) {
                originalRequest._retry = true;
                try {
                    // พยายามขอ Token ใหม่จาก /api/refresh
                    await axios.post("/api/refresh", {}, { withCredentials: true });
                    // ถ้าสำเร็จ ให้ยิง Request เดิมซ้ำ
                    console.log("Token refreshed, retrying original request...");
                    return axios(originalRequest);
                } catch (refreshError) {
                    console.error("Refresh token failed, logging out:", refreshError);
                    alert("เซสชั่นหมดอายุ กรุณาเข้าสู่ระบบใหม่");
                    window.location.href = '/login.html'; // ส่งไปหน้า login
                    return Promise.reject(refreshError);
                }
            }
            // ถ้าเป็น error อื่นที่ไม่ใช่ 401 หรือไม่มี error.response
            return Promise.reject(error);
        }
    );
    document.addEventListener("DOMContentLoaded", () => {
        // --- ส่วน Element ที่ต้องใช้ ---
        const orderIdElement = document.getElementById("order-id");
        const orderDateElement = document.getElementById("order-date");
        const orderTotalElement = document.getElementById("order-total");
        const viewOrderBtn = document.querySelector('a[href*="orderdetails.html"]'); 
        const urlParams = new URLSearchParams(window.location.search);
        const total = urlParams.get("total");
        const paymentIntentId = urlParams.get("pi_id");

        // --- แสดงวันที่และยอดชำระทันที ---
        const today = new Date();
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        orderDateElement.textContent = today.toLocaleDateString('th-TH', options);
        if (total) {
            orderTotalElement.textContent = `฿${parseFloat(total).toFixed(2)}`;
        } else {
            orderTotalElement.textContent = 'N/A';
        }
        // --- ฟังก์ชันสำหรับดึง Order ID ---
        async function fetchOrderId(pi_id, retries = 5) {  // retries = 5 → จะลองดึงข้อมูล สูงสุด 5 ครั้ง
            if (!pi_id) {
                orderIdElement.textContent = `#BK-ERROR`;
                if(viewOrderBtn) viewOrderBtn.style.display = 'none';
                return;
            }
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await axios.get(`/api/order/by-payment-intent/${pi_id}`, { withCredentials: true });
                    if (res.data.orderId) {
                        const orderId = res.data.orderId;
                        orderIdElement.textContent = `#BK-${orderId}`;
                        if(viewOrderBtn) viewOrderBtn.href = `orderdetails.html?orderId=${orderId}`;
                        return;
                    }
                } catch (error) {
                    console.log(`Attempt ${i + 1}: Order not found yet, retrying...`);
                }
                await new Promise(resolve => setTimeout(resolve, 1200)); // เพิ่มเวลาหน่วงเล็กน้อย
            }
            // ถ้าลองแล้วยังไม่เจอ
            orderIdElement.textContent = `#BK-PENDING`;
            if(viewOrderBtn) viewOrderBtn.style.display = 'none';
        }
        fetchOrderId(paymentIntentId);
    });
</script>
</body>

</html>